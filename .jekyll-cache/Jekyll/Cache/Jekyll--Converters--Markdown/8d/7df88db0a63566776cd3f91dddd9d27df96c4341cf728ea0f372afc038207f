I"ük<p>ç°ä»£CPUå¤§å¤šæ•°éƒ½æ”¯æŒå¤šæ ¸ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸è®¡ç®—çš„ä¼˜åŠ¿ï¼Œæ˜¯å·¥ç¨‹å¸ˆå¿…å¤‡çš„æŠ€èƒ½ä¹‹ä¸€ã€‚</p>

<h4 id="å¤šçº¿ç¨‹">å¤šçº¿ç¨‹</h4>

<p>Pythonä¸­å¤šçº¿ç¨‹ç¼–ç¨‹æœ‰ä¸¤ç§ä½¿ç”¨å½¢å¼ï¼ˆCæ‰©å±•æ–¹å¼ä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´å†…ï¼‰ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">calc_sum</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">ss</span> <span class="o">+=</span> <span class="n">i</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"sun of n is {}."</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">ss</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">CountDownThread</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="p">.</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Current n is {}."</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">n</span><span class="p">))</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="c1"># way1
</span>    <span class="n">t1</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">calc_sum</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,))</span>
    <span class="n">t1</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># way2
</span>    <span class="n">t2</span> <span class="o">=</span> <span class="n">CountDownThread</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">t2</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

</code></pre></div></div>

<p><em>way2</em>æ–¹å¼æœ‰ä¸ªç¼ºç‚¹ï¼Œä»»åŠ¡ä¸å¹¶å‘æ–¹å¼å­˜åœ¨ä¸€å®šè€¦åˆã€‚</p>

<p>Pythonä¸­çº¿ç¨‹åˆ†ä¸¤ç±»ï¼šdaemon threadå’Œnon-daemon threadï¼Œå…¶ä¸­daemon threadå®˜æ–¹çš„è§£é‡Šï¼š</p>

<blockquote>

  <p>A thread can be flagged as a â€œdaemon threadâ€. The significance of this flag is that the entire Python program exits when only daemon threads are left. The initial value is inherited from the creating thread. The flag can be set through the <a href="#threading.Thread.daemon"><code class="language-plaintext highlighter-rouge">daemon</code></a> property or the <em>daemon</em> constructor argument.</p>

  <p>Daemon threads are abruptly stopped at shutdown. Their resources (such as open files, database transactions, etc.) may not be released properly. If you want your threads to stop gracefully, make them non-daemonic and use a suitable signalling mechanism such as an <a href="#threading.Event"><code class="language-plaintext highlighter-rouge">Event</code></a>.</p>

  <p>There is a â€œmain threadâ€ object; this corresponds to the initial thread of control in the Python program. It is not a daemon thread.</p>
</blockquote>

<p>å¤§ä½“æ„æ€å°±æ˜¯è¯´ï¼Œdaemonå±æ€§é»˜è®¤å€¼ç»§æ‰¿è‡ªçˆ¶çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹æ˜¯non-daemon threadï¼‰ï¼Œä¸»çº¿ç¨‹é€€å‡ºæ—¶ä¸å¿…ç­‰å¾…daemon threadã€‚</p>

<p>è‡³äºä¸ºä»€ä¹ˆéœ€è¦daemon threadï¼Œè€ƒå¯Ÿè¿™æ ·ä¸€ç±»ä»»åŠ¡çº¿ç¨‹ï¼š<em>GC</em>ã€å¿ƒè·³åŒ…ç­‰ï¼Œè¿™ç±»çº¿ç¨‹åªåœ¨ä¸»çº¿ç¨‹è¿è¡Œæ—¶æ‰æœ‰ç”¨ï¼Œè¿è¡Œå®Œæ¯•åå³å¯ç»ˆæ­¢ã€‚è‹¥æ²¡æœ‰<em>daemon thread</em>ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨çš„è·Ÿè¸ªè¿™äº›çº¿ç¨‹å¹¶åœ¨ä¸»çº¿ç¨‹é€€å‡ºæ—¶ï¼Œæ‰‹åŠ¨çš„å…³é—­å®ƒä»¬ã€‚é€šè¿‡è®¾ç½®æˆ<em>daemon thread</em>ï¼Œå½“ä¸»çº¿ç¨‹é€€å‡ºæ—¶ï¼Œè¿™ç±»çº¿ç¨‹å°±è¢«è‡ªåŠ¨ç»ˆæ­¢äº†ï¼ˆçŒœæµ‹æ˜¯è§£é‡Šå™¨æ‰˜ç®¡äº†è¿™äº›çº¿ç¨‹ï¼‰ã€‚</p>

<p><em>stackoverflow</em>ä¸Šæœ‰ä¸ªå…³äº<em>daemon thread</em>çš„è§£é‡Š<a href="https://stackoverflow.com/questions/190010/daemon-threads-explanation"><em>Daemon Threads Explanation</em></a></p>

<hr />

<h4 id="gil">GIL</h4>

<p>ä»ä¸€ä¸ªç®€å•ä¾‹å­çœ‹èµ·ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">single_thread</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">fib</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">fib</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">fib</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">te</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">r</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'{:.5f}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">te</span> <span class="o">-</span> <span class="n">tb</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">r</span>


<span class="k">def</span> <span class="nf">multi_thread</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">fib</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,))</span>
            <span class="n">ts</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">tb</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">:</span>
            <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">:</span>
            <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">te</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">r</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'{:.5f}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">te</span> <span class="o">-</span> <span class="n">tb</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span>


<span class="n">t1</span> <span class="o">=</span> <span class="n">single_thread</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">multi_thread</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>

</code></pre></div></div>

<p>åœ¨æˆ‘$12$æ ¸ç”µè„‘ä¸Šè¿è¡Œç»“æœä¸º:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span><span class="s1">'0.84675'</span>, <span class="s1">'0.86230'</span>, <span class="s1">'0.87799'</span>, <span class="s1">'0.84974'</span>, <span class="s1">'0.85043'</span>, <span class="s1">'0.85675'</span>, <span class="s1">'0.82343'</span>, <span class="s1">'0.82434'</span>, <span class="s1">'0.83729'</span>, <span class="s1">'0.84523'</span>, <span class="s1">'0.83385'</span>, <span class="s1">'0.83480'</span>, <span class="s1">'0.82559'</span>, <span class="s1">'0.82848'</span>, <span class="s1">'0.83206'</span>, <span class="s1">'0.82472'</span>, <span class="s1">'0.82823'</span>, <span class="s1">'0.82451'</span>, <span class="s1">'0.83502'</span>, <span class="s1">'0.82901'</span><span class="o">]</span>
<span class="o">[</span><span class="s1">'0.85296'</span>, <span class="s1">'0.87298'</span>, <span class="s1">'0.85680'</span>, <span class="s1">'0.84538'</span>, <span class="s1">'0.85485'</span>, <span class="s1">'0.84925'</span>, <span class="s1">'0.84522'</span>, <span class="s1">'0.83931'</span>, <span class="s1">'0.86896'</span>, <span class="s1">'0.86092'</span>, <span class="s1">'0.85658'</span>, <span class="s1">'0.84691'</span>, <span class="s1">'0.86612'</span>, <span class="s1">'0.85414'</span>, <span class="s1">'0.84543'</span>, <span class="s1">'0.86851'</span>, <span class="s1">'0.84650'</span>, <span class="s1">'0.85566'</span>, <span class="s1">'0.85589'</span>, <span class="s1">'0.85259'</span><span class="o">]</span>

</code></pre></div></div>

<p>å¤šæ¬¡è¿è¡Œä¸Šè¿°è„šæœ¬å¹¶è§‚å¯Ÿå®éªŒç»“æœï¼Œä¼šå¾—å‡ºä¸€ä¸ªäº‹å®ï¼šå•çº¿ç¨‹æ–¹å¼å¤§å¤šæ•°æ—¶å€™éƒ½æ¯”å¤šçº¿ç¨‹æ–¹å¼å¿«ã€‚</p>

<p>æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´äº†è¿™ç§ç°è±¡ï¼Ÿ</p>

<p>é¦–å…ˆï¼Œéœ€è¦äº†è§£ä¸€ä¸ªåŸºæœ¬äº‹å®ï¼ŒPythonå­˜åœ¨å¤šç§è§£é‡Šå™¨ï¼Œå¸¸è§çš„å¦‚CPythonã€Jythonã€PyPyç­‰ï¼Œç”¨çš„æ¯”è¾ƒå¤šçš„è§£é‡Šå™¨å½“å±<em>CPython</em>ï¼Œè€Œ<em>GIL</em>å°±æ˜¯<em>CPython</em>ä¸­å­˜åœ¨çš„é—®é¢˜ï¼Œè¿™ä¹Ÿé—´æ¥è¯´æ˜äº†<em>GIL</em>å¹¶ä¸æ˜¯<em>Python</em>è¯­è¨€çš„ç‰¹æ€§ã€‚</p>

<p><em>CPython</em>ä¸­å¯¹<em>GIL</em>å®˜æ–¹è§£é‡Š:</p>

<blockquote>
  <p><em>In CPython, the global interpreter lock, or GIL, is a mutex that prevents multiple native threads from executing Python bytecodes at once. This lock is necessary mainly because CPythonâ€™s memory management is not thread-safe. (However, since the GIL exists, other features have grown to depend on the guarantees that it enforces.)</em></p>
</blockquote>

<p>ä»ä¸Šè¿°è§£é‡Šä¸­å¯ä»¥å¾—çŸ¥ï¼Œæ˜¯ç”±äº<em>CPython</em>å†…å­˜ç®¡ç†æ˜¯éçº¿ç¨‹å®‰å…¨å¯¼è‡´äº†<em>GIL</em>å­˜åœ¨ï¼Œ<em>GIL</em>é™åˆ¶äº†åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ª<strong><em>native thread</em></strong>èƒ½æ‰§è¡Œå­—èŠ‚ç ã€‚</p>

<p>é‚£<em>CPython</em>å†…å­˜ç®¡ç†ä¸ºä»€ä¹ˆæ˜¯éçº¿ç¨‹å®‰å…¨ï¼Œä¸»è¦åŸå› åœ¨äº<em>Python</em>ä½¿ç”¨å¼•ç”¨è®¡æ•°ç®¡ç†å†…å­˜:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sys</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sys</span><span class="p">.</span><span class="n">getrefcount</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="mi">3</span>
</code></pre></div></div>

<p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¼•ç”¨è®¡æ•°æ–¹å¼ä¼šé¢ä¸´ç«äº‰æ¡ä»¶ï¼Œè¿›è€Œå¯¼è‡´å†…å­˜æ³„æ¼ç­‰å…¶ä»–é—®é¢˜ï¼Œæ•…è€Œé‡‡ç”¨ä¸²åŒ–æ–¹å¼æ¥è§„é¿äº†è¯¥é—®é¢˜ã€‚</p>

<p>é‚£æ˜¯ä¸æ˜¯ç”¨<em>CPython</em>è§£é‡Šå™¨çš„<em>Python</em>ç¨‹åºå¤šçº¿ç¨‹å°±æ²¡æœ‰ç”¨äº†ã€‚</p>

<p>å½“ç„¶ä¸æ˜¯ï¼Œä»»åŠ¡ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§ï¼š<em>CPU</em>ç¹å¿™å‹å’Œ<em>IO</em>ç¹å¿™å‹ï¼Œé’ˆå¯¹<em>IO</em>ç¹å¿™å‹ï¼Œ<em>Python</em>çš„å¤šçº¿ç¨‹è¿˜æ˜¯æœ‰ä¸€å®šä¼˜åŠ¿ï¼Œè§£é‡Šå™¨åœ¨çº¿ç¨‹é˜»å¡æ—¶ä¼šé‡Šæ”¾<em>GIL</em>ä»¥ä¾¿å…¶ä»–çº¿ç¨‹æ‰§è¡Œã€‚</p>

<p>å¦å¤–ï¼Œ<em>CPython</em>ä¸­ä¹Ÿæ˜¯é‡‡ç”¨æ—¶é—´ç‰‡è½®è½¬çš„æ–¹å¼è¿›è¡Œçº¿ç¨‹åˆ‡æ¢ï¼Œå…¶é—´éš”æ—¶é—´å¯ä»¥é€šè¿‡<em>sys.getswitchinterval</em>è·çŸ¥ã€‚</p>

<p>è‡³æ­¤ï¼Œä¹Ÿå°±èƒ½è§£é‡Šé€šä¸ºä»€ä¹ˆä¸Šè¿°ä»£ç ä¸­å¤šçº¿ç¨‹ç‰ˆæœ¬ä¼šæ¯”å•çº¿ç¨‹ç‰ˆæœ¬æ…¢äº†ï¼šç”³è¯·é”ã€é‡Šæ”¾é”ã€çº¿ç¨‹åˆ‡æ¢å­˜åœ¨ä¸€å®šçš„å¼€é”€ã€‚</p>

<p>é€šè¿‡ä»¥ä¸Šåˆ†æå¯ä»¥å¾—çŸ¥ï¼Œåœ¨ä»¥<em>CPython</em>ä¸ºæ‰§è¡Œè§£é‡Šå™¨çš„<em>Python</em>ç¨‹åºä¸­ï¼Œå¤šçº¿ç¨‹ç¼–ç¨‹å¹¶ä¸é€‚åˆ<em>CPU</em>ç¹å¿™å‹ä»»åŠ¡ã€‚</p>

<hr />

<h4 id="rlock">RLock</h4>

<p>RLockï¼Œåä¸ºå¯é‡å…¥é”ï¼Œå…¶åº”ç”¨åœºæ™¯ï¼šä¸€ä¸ªçº¿ç¨‹è·å–åˆ°é”$lock_1$åã€æœªé‡Šæ”¾$lock_1$ä¹‹å‰åˆè°ƒç”¨äº†éœ€è¦è·å–$lock_1$çš„å‡½æ•°ã€‚</p>

<p>é—æ†¾çš„æ˜¯ï¼Œåœ¨å·¥ä½œä¸­æ²¡æœ‰ç¢°ä¸Šè¿‡ä½¿ç”¨<em>RLock</em>çš„åœºæ™¯ï¼Œè¿™é‡Œç®€å•å’Œ<em>Lock</em>åšä¸‹å¯¹æ¯”:</p>

<ul>
  <li><em>Lock</em>å¯¹è·å–é”ã€é‡Šæ”¾é”çº¿ç¨‹æ²¡æœ‰è¦æ±‚ï¼Œ<em>RLock</em>è¦æ±‚é‡Šæ”¾é”çº¿ç¨‹å¿…é¡»æ˜¯è·å¾—é”çº¿ç¨‹</li>
</ul>

<p>æ›´ç¡®åˆ‡çš„è¯´ï¼Œ<em>RLock</em>åªæ˜¯<em>Lock</em>æ›´é«˜å±‚çš„æŠ½è±¡ï¼Œå†…éƒ¨é€šè¿‡è®°å½•<em>owning thread</em>å’Œ<em>recursion level</em>å³å¯ã€‚</p>

<hr />

<h4 id="condition-variable">Condition Variable</h4>

<p>æ¡ä»¶å˜é‡ï¼Œå¯çœ‹æˆæ˜¯ä¸€ç§åœºæ™¯æ¨¡å‹ï¼Œæ‹¿ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…æ¨¡å‹æ¥è¯´ï¼Œç”Ÿäº§è€…å‘é˜Ÿåˆ—ä¸­æ”¾å…¥å…ƒç´ æ—¶å…ˆè·å–åˆ°<em>lock</em>åï¼Œéœ€åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦å·²æ»¡ï¼Œè‹¥å·²æ»¡ï¼Œåˆ™æŒ‚èµ·è‡ªèº«ã€‚è¿™é‡Œé¢çš„æ˜¯å¦å·²æ»¡å°±æ˜¯ä¸ªæ¡ä»¶ï¼Œæ¡ä»¶å˜é‡å¤„ç†çš„åœºæ™¯å‡ ä¹éƒ½ç±»ä¼¼äºæ­¤ï¼Œåç»­æåˆ°çš„<em>Semaphore</em>ã€<em>Event</em>å†…éƒ¨éƒ½æ˜¯åŸºäºæ¡ä»¶å˜é‡å®ç°çš„ã€‚</p>

<p>æ¡ä»¶å˜é‡å¤„ç†åœºæ™¯æ¨¡å‹:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Consume one item
</span><span class="k">with</span> <span class="n">cv</span><span class="p">:</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">an_item_is_available</span><span class="p">():</span>
        <span class="n">cv</span><span class="p">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="n">get_an_available_item</span><span class="p">()</span>

<span class="c1"># Produce one item
</span><span class="k">with</span> <span class="n">cv</span><span class="p">:</span>
    <span class="n">make_an_item_available</span><span class="p">()</span>
    <span class="n">cv</span><span class="p">.</span><span class="n">notify</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h4 id="semaphore">Semaphore</h4>

<p>semaphoreï¼Œåä¸ºä¿¡å·é‡ï¼Œå¯ç”¨äºçº¿ç¨‹åŒæ­¥ã€èµ„æºè®¿é—®é™åˆ¶ï¼Œæ¯”å¦‚é™åˆ¶åŒä¸€æ—¶åˆ»è‡³å¤šæœ‰$3$ä¸ªçº¿ç¨‹è®¿é—®æ‰“å°æœºï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="n">limit_sema</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">printer</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">current_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">current_thread</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">limit_sema</span><span class="p">:</span>
        <span class="c1"># simulate time-consuming operation
</span>        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'{} thread print content:{}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">current_thread</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>


<span class="n">ts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">printer</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="p">))</span>
    <span class="n">ts</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">:</span>
    <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>

</code></pre></div></div>

<p>è¿è¡Œè¾“å‡º:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Thread-1 thread print content:0
Thread-2 thread print content:1
Thread-3 thread print content:2

Thread-4 thread print content:3
Thread-5 thread print content:4
Thread-6 thread print content:5

Thread-7 thread print content:6
Thread-8 thread print content:7
Thread-9 thread print content:8

Thread-10 thread print content:9

</code></pre></div></div>

<p>ä»è¾“å‡ºä¸­ä¹Ÿå¯ä»¥å‘ç°ï¼ŒåŒä¸€æ—¶åˆ»è‡³å¤šæœ‰$3$ä¸ªçº¿ç¨‹æ‹¥æœ‰æ‰“å°æœºçš„æ‰§è¡Œæƒã€‚</p>

<hr />

<h4 id="queue">Queue</h4>

<p><em>queue</em>æ¨¡å—ä¸‹æä¾›äº†å¸¸è§çš„çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼Œæ¯”å¦‚å…ˆè¿›å…ˆå‡º(<em>FIFO</em>)ã€åè¿›å…ˆå‡º(<em>LIFO</em>)ã€ä¼˜å…ˆçº§é˜Ÿåˆ—ç­‰ï¼Œä¸è¿‡å®ƒä»¬åŸºæœ¬ä½¿ç”¨æ–¹å¼å¤§éƒ½ç±»ä¼¼:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="n">broker</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">Queue</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">worker</span><span class="p">():</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">broker</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="n">broker</span><span class="p">.</span><span class="n">task_done</span><span class="p">()</span>

<span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">multiprocessing</span><span class="p">.</span><span class="n">cpu_count</span><span class="p">()):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">)</span>
    <span class="n">threads</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

<span class="c1"># simulate producer produce data
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">broker</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="c1"># block until all task are done
</span><span class="n">broker</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>

<span class="c1"># stop workers
</span><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
    <span class="n">broker</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
    <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h4 id="çº¿ç¨‹æ± ">çº¿ç¨‹æ± </h4>

<p>çº¿ç¨‹åˆ›å»ºã€é”€æ¯å­˜åœ¨ä¸€å®šçš„å¼€é”€ï¼Œå¾ˆå¤šæ—¶å€™æ˜¯é€šè¿‡é‡‡ç”¨çº¿ç¨‹æ± çš„æ–¹å¼æ¥é¿å…äº†è¿™éƒ¨åˆ†å¼€é”€ã€‚æ ‡å‡†åº“ä¸­åŒæ ·æä¾›äº†çº¿ç¨‹æ± ä¾›å¼€å‘è€…ä½¿ç”¨ï¼Œå…¶æ¥å£ä¸è¿›ç¨‹æ± æ¥å£ä¸€è‡´:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">multiprocessing.pool</span> <span class="kn">import</span> <span class="n">ThreadPool</span>

<span class="k">def</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>

<span class="k">with</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">thread_pool</span><span class="p">:</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>
            <span class="n">tasks</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">thread_pool</span><span class="p">.</span><span class="n">starmap_async</span><span class="p">(</span><span class="n">multiply</span><span class="p">,</span> <span class="n">tasks</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">get</span><span class="p">())</span>

</code></pre></div></div>

<hr />

<h3 id="æ‚è¨€">æ‚è¨€</h3>

<p><em>threading</em>æ¨¡å—ä¸­<em>Lock</em>ã€<em>Event</em>æœ¬æ–‡å¹¶æ²¡æœ‰æåŠï¼Œä¸»è¦åŸå› åœ¨äºå…¶ä½¿ç”¨æ–¹å¼è¿‡äºç®€å•äº†ã€‚</p>

<h4 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h4>

<p><a href="https://docs.python.org/3/library/queue.html">queue</a></p>

<p><a href="https://docs.python.org/3/library/threading.html#module-threading">threading</a></p>

<p><a href="https://realpython.com/python-gil/">GIL</a></p>

:ET